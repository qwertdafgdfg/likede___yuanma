# 亿可控面试问题汇总

#### 1.简述一下亿可控项目

亿可控是一个物联网中台, 对设备运行状况进行实时在线监测、预警和透传，不做业务相关的功能。它的特点时可以对接市面上95%的物联网设备，并且与其业务系统做对接。核心功能有报文数据采集与指标解析、报警监控、GPS定位监控、数据看板。采用的技术包括EMQ 、时间序列数据库influxDB、elasticsearch等。

> 延展问题：
>
> 【1】什么是报文数据采集与指标解析 ？
>
> 整个系统的数据来源是通过接收设备发送过来的报文消息，在系统中定义主题和消息内容字段的指标数据为过滤条件，从而对消息进行收集和分析。
>
> 【2】什么是报警监控  ？
>
> 通过和系统中定义的各种告警级别数据进行对比，一旦发现触发到告警级别的消息，就会通过和告警关联配置的webhook来将告警信息透传到其它系统
>
> 【3】什么是GPS定位监控？
>
> 可以按照预先定义的解析规则采集每台设备的GPS定位，在亿可控的首页上有地图看板可以查看到每个设备的定位信息。
>
> 【4】数据看板都包括哪些？   
>
> 异常设备top10、异常设备列表、设备状态统计、异常告警趋势、自定义看板
>
> 【5】怎么理解中台？
>
> 亿可控就是一个中台，它只专注与指标的解析、报警的逻辑以及gps数据的查询，而这些功能几乎是所有物联网行业软件的一个通用需求。我们本着不重复造轮子的思想，开发这套系统，就是可以让物联网公司可以专注于开发业务，而对物联网设备的监控就交给中台。业务系统如果需要指标数据或者处理报警逻辑，也可以通过亿可控中台来转递。亿可控提供了数据透传功能，可以方便与其他业务系统对接。



#### 2.为什么使用时间序列数据库influxDB？

InfluxDB是一种用Go编写的时间序列数据库，主要用来存储一些时间序列的数据。提供了简单、高效的HTTP读写接口，可以使用类似SQL的语言InfluxQL查询聚合数据，能够使用Tag进行快速高效的查询。

一般来说，物联网设备会比较频繁的发送报文，如果使用mysql来存储肯定会对mysql造成很大的压力甚至是挂掉，而InfluxDB可以承载很高的写入和查询操作，在物联网项目开发中比较常见。


#### 3.亿可控怎么采集物联网设备发送的信息？

亿可控是通过订阅EMQ消息来实现物联网设备的接收的。物联网设备报文千奇百怪，亿可控是怎么实现对这些报文进行解析的呢？   亿可控有一个指标配置表用于定义报文的解析规则，其字段包括主题名称、设备识别码字段、指标值字段、指标值类型等。当接收到EMQ的消息后，会根据这张指标配置表的规则来进行指标值的提取。



#### 4.亿可控是如何实现报警的？（简述报警业务模块）

亿可控的报警分为指标报警和离线报警。

亿可控的指标报警是基于指标解析的。我们有一个报警规则表，定义了报警的阈值，当达到或超过这个阈值则进行报警，我们会将报警的信息根据定义的钩子地址透传给业务系统来处理，亿可控本身并不会对报警进行业务处理。另外的业务系统收到这个报警可能会推送APP通知、发送短信、发送邮件、创建维修工单等逻辑。为了避免频繁的发送报警信息，我们设置了报警的沉默周期，在沉默周期内是不会重复报警的。

当某个设备离线了，亿可控会触发离线报警，离线报警也会透传给其他的业务系统处理。离线报警的原理是通过EMQ的webhook来实现的。

> 延展问题：沉默周期是什么？如何实现的？
>
> 物联网的报文是定时发送的，如果这次发送的指标是报警的，间隔几秒钟发送还是报警的，这样重复的发送报警信息会给用户造成困扰，所以我们通过设置沉默周期，这样就沉默周期内如果有相同的设备相同的指标报警就会忽略，超过沉默周期再次收到报警指标才会再次发送报警。
>
> 我们是通过redis的过期时间来实现沉默周期的逻辑的。我们在发送报警信息后向redis存储一个值（存什么无所谓），key中包含设备编号和告警编号，设置过期时间就是沉默周期，当接收的指标属于报警指标，会先查询redis，如果能查询到则表示还在沉默周期内，不做任何处理。
>

#### 5.亿可控如何实现GPS数据采集与存储？

亿可控有专门的gps规则表，用于定义gps数据的解析规则。当亿可控接收到物联网报文后，根据gps定义的解析规则进行解析。解析规则包括单字段和双字段两种。单字段指的是经纬度是报文中的一个值，中间用特定的分隔符分隔，而双字段指的是经度纬度是报文中的两个值。

解析后，我们将其保存到elasticsearch中，字段的类型是geo_point。这里注意的问题是，报文传过来的是经度在前纬度在后，而elasticsearch存储的是纬度在前经度在后，所以我们需要编写逻辑对调经纬度的顺序。



#### 6.说一下亿可控的异常设备列表。

亿可控的异常设备列表是可以实时检测异常设备的。当亿可控首页打开的时候，亿可控的异常设备列表实际上是空的，当亿可控接收到指标判断为报警后，会把报警信息封装后发给emq，主题是/device/alarm，此时前端也通过mqtt.js连接了EMQ并订阅了/device/alarm主题，这样就实现了前端的推送。最终效果是不需要刷新页面就可以看到最新的设备报警信息。



#### 7.当业务中经常用到某个表的数据，如何优化避免读取过于频繁？

如果某个表数据是频繁读取，应该使用缓存来缓解压力。 为了代码更加优雅利于维护，我们可以配置mybatisplus二级缓存。

> 延展问题：如何配置mybatisplus二级缓存？
>
> （1）在配置中添加配置开启二级缓存  mybatis-plus.configuration.cache-enabled值为true。
>
> （2）编写二级缓存处理类，实现Cache接口来处理二级缓存逻辑，类中主要使用了RedisTemplate来操作redis
>
> （3）在Mapper接口上添加注解@CacheNamespace，注解的implementation和eviction指定为二级缓存处理类.class。



#### 8.项目中哪些场景使用了influxDB特殊函数或语法？

（1）异常告警趋势报表使用到了time函数，这个函数是放在group by 后边的，time函数的参数是时间周期，比如time(1d)就是每天进行聚合，time(1h)就是每小时聚合，time(1m)就是每分钟聚合。

（2）自定义指标报表使用了first函数，该函数是放在select后边的，通常与time函数一起用，主要是用于得到某个时间点之后最近的那条指标数据。

（3）告警次数top10设备指标报表使用到了top函数，该函数是放在select后边的，可以用于根据tags排序并取得前几条数据。top函数的参数格式大于等于2个。第1个是用于排序的字段，最后1个是去多少条数据，中间的参数是用于显示的字段。





